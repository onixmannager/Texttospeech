<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Mantener mismo CSS -->
</head>
<body>
  <div class="container">
    <!-- Mantener misma estructura HTML -->
  </div>

  <script>
    // Voz a Texto Corregido
    const startButton = document.getElementById("start-btn");
    const saveButton = document.getElementById("save-btn");
    const output = document.getElementById("output");
    const status = document.getElementById("status");
    let recognition;
    let isRecording = false;

    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = "es-ES";

      recognition.onstart = () => {
        startButton.innerHTML = `<span class="mic-icon"></span><span>Detener grabación</span>`;
        startButton.classList.add('recording');
        status.textContent = "Grabando...";
        saveButton.disabled = false;
      };

      recognition.onend = () => {
        startButton.innerHTML = `<span class="mic-icon"></span><span>Iniciar grabación</span>`;
        startButton.classList.remove('recording');
        status.textContent = "Grabación detenida";
        isRecording = false;
      };

      recognition.onresult = (event) => {
        let finalTranscript = '';
        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            interimTranscript += transcript;
          }
        }

        output.value = finalTranscript + interimTranscript;
        output.scrollTop = output.scrollHeight;
      };

      startButton.addEventListener("click", () => {
        if (isRecording) {
          recognition.stop();
          isRecording = false;
        } else {
          output.value = '';
          recognition.start();
          isRecording = true;
        }
      });

      saveButton.addEventListener("click", () => {
        const blob = new Blob([output.value], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `transcripcion_${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      });
    } else {
      status.textContent = "Navegador no compatible con reconocimiento de voz";
    }

    // Texto a Voz y Grabación de Audio
    const speakButton = document.getElementById("speak-btn");
    const saveAudioButton = document.getElementById("save-audio-btn");
    const textToSpeech = document.getElementById("text-to-speech");
    let mediaRecorder;
    let audioChunks = [];

    const setupAudioRecording = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const mediaStreamDestination = audioContext.createMediaStreamDestination();
        mediaRecorder = new MediaRecorder(mediaStreamDestination.stream);

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const audioUrl = URL.createObjectURL(audioBlob);
          const a = document.createElement('a');
          a.href = audioUrl;
          a.download = `audio_${new Date().toISOString().slice(0,10)}.wav`;
          a.click();
          URL.revokeObjectURL(audioUrl);
          audioChunks = [];
        };
      } catch (err) {
        console.error('Error al configurar grabación de audio:', err);
      }
    };

    setupAudioRecording();

    if ('speechSynthesis' in window) {
      speakButton.addEventListener("click", () => {
        const text = textToSpeech.value;
        if (text) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'es-ES';
          utterance.rate = 1;
          
          // Iniciar grabación
          saveAudioButton.disabled = false;
          mediaRecorder.start();
          
          utterance.onend = () => {
            mediaRecorder.stop();
            speakButton.disabled = false;
            saveAudioButton.disabled = true;
          };
          
          speechSynthesis.speak(utterance);
          speakButton.disabled = true;
        }
      });
    } else {
      speakButton.disabled = true;
      speakButton.textContent = "Función no disponible";
    }

    saveAudioButton.addEventListener("click", () => {
      mediaRecorder.stop();
    });
  </script>
</body>
</html>
